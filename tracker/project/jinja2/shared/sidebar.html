{% if  standalone %} 
<div id="sidebar" class="sidebar">
</div>
{% endif %} 

<script type="module" id="sidebar-js" hx-swap-oob="true">
import fetch_recipies from "fetch-recipies";
import {ui_state} from "d3-ui";
var current_url =  "{{request.path}}" ;
const urls = _.filter([
    {
     url : "{{url("project:main")}}" ,
     html : "My Projects",
     children  : await  fetch_recipies.GETjson(ui_state.models["project.MinProject"].main),
    },
    {
     url : "{{url("project:main")}}" ,
     html : "Time Reporting",
     children  : [],
    },
    {
      url : false,
      html: "Team",
      children : ui_state.current_user.manages ? ui_state.current_user.manages.users  : false
    },
    {
     url : false, 
     html : "Groups",
     children :  await  fetch_recipies.GETjson(ui_state.models["project.ProjectGroup"].main),
    },
    {
     url :  "{{url("project:metadata")}}", 
     html : "Edit Tags / Contacts",
     children : []
    },
], d=> d.children !== false);

_.chain(urls)
 .map(d=>d.children)
 .flatten()
 .each(d=>{
    d.url =  ui_state.models[d.__type__].main_pk.replace("__pk__",d.id);
 })
 .value();

const redraw = ()=> {
    const projects = d3.select("#sidebar")
      .on("click", e=>{
         if (e.target.tagName == "A") {
             d3.select("#main-content").html("");
             current_url = d3.select(e.target).datum().url;
             ui_state.reset_ui(false);
             redraw();
         }
      })
      .selectAll("div")
      .data(urls,d=>d.html)
      .join("div")
      .each(function(d){
         const sel = d3.select(this);
         if (d.url) {
             sel.selectAll("a")
                .data([d])
                .join("a")
                .attr("class" , d=> {
                    if (d.url == current_url){
                       return "link-primary fw-bold"
                    }  else {
                       return "link body-emphasis"
                    }
                })
                .attr("hx-get",d=>d.url ? d.url : "")
                .attrs({
                  "href" : "#",
                  "hx-target":"#main-content",
                  "hx-replace-url":"true",
                })
                .html(d=>d.html)
                .setup_htmx()
         }  else {
             sel.selectAll("span")
                .data([d])
                .join("span")
                .attr("class" , d=>  "body-emphasis")
                .html(d=>d.html)
         }

          sel.selectAll("ul")
            .data([d])
            .join("ul")
            .styles({
            "padding-left" : "2px",
            "list-style" : "none",
            "max-height" : "300px", 
            "overflow-x" : "hidden", 
            "overflow-y" : "auto", 
            "scrollbar-width" : "thin"})
            .attr("class","mt-2")
            .selectAll("li")
            .data(d=>d.children,d=>d.id)
            .join("li")
            .attr("class","pt-2 text-nowrap")
            .selectAll("span")
            .data(d=>[d])
            .join("span")
            .attr("class" , d=> {
                if (d.url == current_url){
                   return "bg-primary text-white p-2 rounded"
                }  else {
                   return "pt-2"
                }
            })
            .selectAll("a")
            .data(d=>[d])
            .join("a")
            .attr("class" , d=> {
                if (d.url == current_url){
                   return "text-white"
                }  else {
                   return "link-secondary"
                }
            })
            .classed("text-decoration-none",true)
            .attr("hx-get",d=>d.url)
            .style("font-size", "0.8rem")
            .attrs({
              "href" : "#",
              "hx-target":"#main-content",
              "hx-replace-url":"true",
            })
            .setup_htmx()
            .html(d=>d.name)
      })
}
redraw();


</script>
