<div class="row pb-5" style="overflow-x: scroll;flex-wrap: nowrap">
    {% for inst in insts %}
        {% include "stream/stream.html"%}
    {%endfor%}
</div>

<a class="dropdown-item" 
   hx-put="{{url("core:main", kwargs={ "m" : "project.Settings", "pk" : settings.id})}}" 
   hx-vals='{"hide_done" : {%if settings.hide_done%}false{%else%}true{%endif%} }'
   hx-swap="none"
   hx-headers='{"json-response" : true}'
   hx-on::after-request="window.reset_ui('reloadTasks')"
   hx-swap-oob="true"
   id="settings-completed" >
    {%if settings.hide_done%} Show All {%else%} Hide Completed {%endif%}
</a>

<script type="module">
import  { 
    append_edit_attr,
    ui_state,
    make_right_dropdown,
    autoRun,
    is_null,
    create_button,
    inplace_char_edit,
     card_state,
    make_delete_button} from "d3-ui";

const stream_mini = (stream)=>{
    const observable_data = mobx.makeAutoObservable(stream);

    if (d3.select(`#stream${stream.id}`).node() == null){
        return;
    }
    d3.select(`#stream${stream.id}`)
        .call(function(selection){
            inplace_char_edit(selection.append("span"), observable_data, "name", "Name",{display_attr : "name_count"});
            make_delete_button(selection.append("div"), observable_data, d=>d.id, "reloadTasks")
        })
    d3.selectAll(`#stream${stream.id}`).node()
};

const task_summaries = tasks=>{
  _.each(tasks, task=> {
    const observable_data = mobx.makeAutoObservable({...task});

    if (d3.select(`#task${observable_data.id}`).node() == null){
        return;
    }

    d3.select(`#task${observable_data.id}`)
        .data([task])
        .call(function(selection){
            const header_sel =  selection.select(".card-header");
            header_sel.html(""); // clear out placeh9olders
            const header_left = header_sel.append("div").classed("flex-fill",true);
            const body_sel = selection.select(".card-body");
            const footer_sel = selection.select(".card-footer");
            body_sel.html(""); // clear out placeh9olders

           make_right_dropdown(header_sel,dropdown=>{
                make_delete_button( dropdown.append("li").append('span').classed("dropdown-item d-grid",true),task,d=>d.id, "reloadTasks",{html : "Delete", _class : "btn btn-danger"})
           });
           inplace_char_edit(header_left.append("div").style("width","15%").style("display","inline-block"), observable_data, "order", "Order",{btn_class : "btn-outline-primary", on_change : "reloadTasks", input_class : "w-25"} );
           inplace_char_edit(header_left.append("div").style("width","85%").style("display","inline-block"), observable_data, "name", "Name");

            autoRun(selection.node(),()=>{
                card_state.redraw
                body_sel.html("")
                _.each([["text","Notes",""],
                        ["start_date", "Start Date",""],
                        ["target_date","Target Date",""],
                        ["lead", "Contact",{name_attr : "username"}],
                        ["teams", "Teams",{name_attr : "name"}],
                        ["competency", "Competency",""],
                        ["stream", "Stream",{on_change : "reloadTasks"}]], 
                    args=>{
                        if(card_state.minified_cards.includes(observable_data.id) && !is_null(observable_data[args[0]])){
                            append_edit_attr(body_sel, observable_data, ...args);
                        } else if ( !card_state.minified_cards.includes(observable_data.id)){
                            append_edit_attr(body_sel, observable_data, ...args);
                        }
                });

                footer_sel   
                    .selectAll("div.left")                                                 
                    .data([1])
                    .join("div")
                    .classed("left fs-6 d-flex justify-content-center align-items-center expand-task text-body-tertiary text-body", true)
                    .html("")
                    .append("button")
                    .classed("btn btn-small btn-light p-1 mb-1", true)
                    .html(d=> card_state.minified_cards.includes(observable_data.id) ? "+" : "-")
                    .on("click", e => {
                        card_state.toggle_minified_state("task",task)
                    });
            });

            footer_sel   
                 .classed("d-flex justify-content-between align-items-center", true)
                 .append("div")
                 .call(function(foodter_sel){
                    append_edit_attr(foodter_sel, observable_data, "done", "Done",{on_change : "reloadTasks"});
                 })
        })
  });
};

const tasks =  {{dumps(insts)|safe}};
_.chain(tasks)
 .each(stream_mini)
 .map(s=>s.tasks)
 .each(task_summaries)
 .value()
card_state.register(tasks);

</script>
