{% if  standalone %} 
  {% extends "base.html" %} 
  {% block sidebar %}
      {%include "shared/sidebar.html"%}
  {%endblock%}
{% endif %}

{% block nav %}
    {%with navbar=[],navdropdown=[ "project/project-navdropdown.html"]%}
        {%include "navbar.html"%}
    {%endwith%}
{%endblock%}



{% block content %}{%with project=inst %}
<div id={% if not target %}"main-content"{%else%}"{{target}}"{%endif %}
    hx-swap-oob="true">
    <div id="project{{project.id}}" class="card task p-0">
        <div class="card-header">
        </div>
        <div class="card-body pt-0 pb-0 row" style="font-size: 1.2em">
            <div class="col-6 left ">
            </div>
            <div class="col-6 right border-start border-2 p-0" style="overflow-y:scroll;scrollbar-width:none; ">
                {%with _url =  url("core:main", kwargs={ "m" : "project.ProjectLog","pk" : project.log.id })    %}
                    <div hx-trigger="load,reloadLog from:document" 
                         hx-get="{{_url}}">
                    </div>
                {%endwith%}
            </div>
        </div>
        <div class="row align-items-center card-footer text-body-secondary fs-6 p-2">
            <div class=" col-4" id="new-stream">

            </div>
            <div class="col-8">
                {%with params=add_encode_parameter("f",{"ac_filters" :  { "stream" : { "project_id" :inst.id }},
                                                         "attach_to": {"attr" : "project", "pk" : inst.id},
                                                         "excludes" :  ["project","competency"]}),
                       _url =  url("core:create_from_parsed", kwargs={"attr" :"name", "m" : "project.Task"}) %}
                    <p style="font-size: 0.8em" class="text-secondary mb-0">
                        {{models["project.Task"].describe_links(excludes=["competency","project"])}}
                    </p>
                    <div hx-on::after-request="event.detail.requestConfig.verb == 'post' ? window.reset_ui('reloadTasks') : false">
                        <div hx-trigger="load"
                             hx-swap="outerHTML"
                             hx-get="{{_url}}?{{params}}">
                        </div>
                    </div>
                {%endwith%}
            </div>
        </div>
    </div>

    {%with params=add_encode_parameter("f",{"filters" :  { "project" : project.id }}),
               _url =  url("core:main", kwargs={ "m" : "project.Stream"})    %}
        <div hx-trigger="load, reloadTasks from:document" 
             hx-get="{{_url}}?{{params}}">
        </div>
    {%endwith%}

    <script type="module">
        // set projects to be shrinkable
        import { inplace_char_edit, create_button, append_edit_attr, ui_state } from "d3-ui";
        (project => {
            const observable_data = mobx.makeAutoObservable( project);
            const root = d3.select(`#project${project.id}`)
                .call(function(selection){
                    const left_sel = selection.select(".card-body .left");
                    const header_sel = selection.select(".card-header");

                    inplace_char_edit(header_sel, observable_data, "name", "Name",{btn_class : "btn-primary", input_class : "w-25"} );
                    append_edit_attr(left_sel, observable_data, "status","Status");
                    append_edit_attr(left_sel, observable_data, "text","Summary",{display_attr:"text_m"});
                    append_edit_attr(left_sel, observable_data, "short_term_outcomes","Short Term Outcomes",{display_attr:"short_term_outcomes_m"});
                    append_edit_attr(left_sel, observable_data, "long_term_outcomes","Long Term Outcomes",{display_attr:"long_term_outcomes_m"});
                    append_edit_attr(left_sel, observable_data,"lead", "Lead", {name_attr : "username"});
                    append_edit_attr(left_sel, observable_data,"project_manager", "Project Manager", {name_attr : "username"});
                    append_edit_attr(left_sel, observable_data,"project_team", "Project Team",{name_attr : "username"} );
                    append_edit_attr(left_sel, observable_data,"tags", "Tags");
                    append_edit_attr(left_sel, observable_data,"partners", "Partners");
                    create_button( selection.select("#new-stream"), 
                                  ()=>mobx.makeAutoObservable({name:"",__type__:"project.Stream",project:observable_data}),
                                  "name",
                                  "+ Workstream",
                                {on_change : "reloadTasks"})
                });
        })({{dumps(inst)|safe}});
    </script>
</div>


{%endwith%} {%endblock%}
